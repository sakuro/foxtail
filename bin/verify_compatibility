#!/usr/bin/env ruby
# frozen_string_literal: true

# Unified fluent.js compatibility verification script
# This script runs the comprehensive RSpec compatibility tests

require 'pathname'

SCRIPT_DIR = Pathname.new(__FILE__).dirname
PROJECT_ROOT = SCRIPT_DIR.parent

# Colors for output
COLORS = {
  red: "\033[31m",
  green: "\033[32m",
  yellow: "\033[33m",
  blue: "\033[34m",
  magenta: "\033[35m",
  cyan: "\033[36m",
  bold: "\033[1m",
  reset: "\033[0m"
}.freeze

def print_header
  puts "#{COLORS[:bold]}#{COLORS[:cyan]}="*70
  puts "FOXTAIL FLUENT.JS COMPATIBILITY VERIFICATION"
  puts "Running comprehensive RSpec compatibility tests..."
  puts "="*70 + COLORS[:reset]
  puts
end

def print_usage
  puts "#{COLORS[:bold]}Usage:#{COLORS[:reset]}"
  puts "  #{$0}                    # Run all compatibility tests"
  puts "  #{$0} --structure        # Run only structure fixture tests"
  puts "  #{$0} --reference        # Run only reference fixture tests"
  puts "  #{$0} --summary          # Run summary test only"
  puts "  #{$0} --help             # Show this help"
  puts
end

# Parse command line arguments
case ARGV.first
when '--help', '-h'
  print_header
  print_usage
  puts "#{COLORS[:yellow]}This script provides a unified interface to fluent.js compatibility testing."
  puts "All tests are implemented as comprehensive RSpec specs in:"
  puts "  spec/fluent_js_compatibility_spec.rb#{COLORS[:reset]}"
  exit 0
when '--structure'
  test_filter = 'fixtures_structure'
when '--reference' 
  test_filter = 'fixtures_reference'
when '--summary'
  test_filter = 'overall compatibility'
else
  test_filter = nil # Run all tests
end

print_header

# Change to project root directory
Dir.chdir(PROJECT_ROOT)

# Build the rspec command
rspec_cmd = ['bundle', 'exec', 'rspec', 'spec/fluent_js_compatibility_spec.rb', '--format', 'documentation']

if test_filter
  rspec_cmd << '--example' << test_filter
end

puts "#{COLORS[:blue]}Running: #{rspec_cmd.join(' ')}#{COLORS[:reset]}"
puts

# Execute the RSpec tests
success = system(*rspec_cmd)

puts
if success
  puts "#{COLORS[:green]}#{COLORS[:bold]}✅ All compatibility tests passed!#{COLORS[:reset]}"
  puts "#{COLORS[:green]}The Foxtail parser achieves near 100% fluent.js compatibility.#{COLORS[:reset]}"
else
  puts "#{COLORS[:red]}#{COLORS[:bold]}❌ Some compatibility tests failed.#{COLORS[:reset]}"
  puts "#{COLORS[:yellow]}Check the output above for details.#{COLORS[:reset]}"
end

puts "#{COLORS[:cyan]}="*70 + COLORS[:reset]

# Exit with same status as RSpec
exit success ? 0 : 1