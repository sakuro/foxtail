name: Release Validation

# This workflow validates release PRs before they are merged.
# It performs comprehensive checks on version, dependencies, and release readiness.

env:
  RUNTIME_GEM_NAME: foxtail-runtime
  TOOLS_GEM_NAME: foxtail-tools

on:
  pull_request:
    branches: [main]

jobs:
  validate-release:
    # Only run for release branches
    if: startsWith(github.head_ref, 'release-v')
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Required for git tag push

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: "3.2"
        bundler-cache: true

    - name: Extract version from branch name
      id: version
      env:
        BRANCH_NAME: ${{ github.head_ref }}
      run: |
        VERSION=${BRANCH_NAME#release-v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT

    - name: Validate version format
      run: |
        if ! echo "${{ steps.version.outputs.version }}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "‚ùå Error: Version must be in format x.y.z (e.g., 1.0.0)"
          exit 1
        fi

    - name: Verify version consistency
      run: |
        check_version() {
          local file="$1"
          local name="$2"
          local file_version
          file_version=$(grep 'VERSION = ' "$file" | sed 's/.*VERSION = "\(.*\)".*/\1/')
          if [ "$file_version" != "${{ steps.version.outputs.version }}" ]; then
            echo "‚ùå Error: Version mismatch for $name. File: $file_version, Expected: ${{ steps.version.outputs.version }}"
            exit 1
          fi
        }

        check_version foxtail-runtime/lib/foxtail/runtime/version.rb foxtail-runtime
        check_version foxtail-tools/lib/foxtail/tools/version.rb foxtail-tools

    - name: Verify git tag exists
      run: |
        # Tag should exist because release-preparation creates it before the PR
        if git tag | grep -q "^${{ steps.version.outputs.tag }}$"; then
          echo "‚úÖ Git tag ${{ steps.version.outputs.tag }} exists"
        else
          echo "‚ùå Error: Git tag ${{ steps.version.outputs.tag }} does not exist"
          echo "The release-preparation workflow should have created this tag"
          exit 1
        fi

    - name: Check if version already released on RubyGems
      run: |
        check_rubygems() {
          local name="$1"
          if gem list "$name" --remote | grep -q "${{ steps.version.outputs.version }}"; then
            echo "‚ùå Error: Version ${{ steps.version.outputs.version }} already exists on RubyGems for $name"
            exit 1
          fi
        }

        check_rubygems ${{ env.RUNTIME_GEM_NAME }}
        check_rubygems ${{ env.TOOLS_GEM_NAME }}

    - name: Validate CHANGELOG format
      run: |
        check_changelog() {
          local file="$1"
          if ! grep -q "^## \[${{ steps.version.outputs.version }}\]" "$file"; then
            echo "‚ùå Error: $file missing section for version ${{ steps.version.outputs.version }}"
            exit 1
          fi
        }

        check_changelog foxtail-runtime/CHANGELOG.md
        check_changelog foxtail-tools/CHANGELOG.md

    - name: Set git user for tag update
      if: github.event.action == 'synchronize'  # When new commits are pushed to PR
      uses: git-actions/set-user@v1

    - name: Update release tag to latest commit
      if: github.event.action == 'synchronize'  # When new commits are pushed to PR
      run: |
        echo "Updating tag v${{ steps.version.outputs.version }} to latest commit"

        # Force update the tag to current HEAD
        git tag -fa "v${{ steps.version.outputs.version }}" \
          -m "Release v${{ steps.version.outputs.version }}"

        # Force push the updated tag
        git push origin "v${{ steps.version.outputs.version }}" --force

        echo "üè∑Ô∏è Tag v${{ steps.version.outputs.version }} updated to commit $(git rev-parse --short HEAD)"

    - name: Release validation summary
      run: |
        echo "‚úÖ Release validation passed for v${{ steps.version.outputs.version }}"
        echo "- Version format is valid"
        echo "- Version consistency verified"
        echo "- Git tag exists"
        if [ "${{ github.event.action }}" == "synchronize" ]; then
          echo "- Git tag updated to latest commit"
        fi
        echo "- Version not yet on RubyGems"
        echo "- CHANGELOGs are properly formatted"
        echo "- Quality checks handled by CI workflow"
