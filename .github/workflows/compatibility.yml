name: Compatibility Tests

# This workflow runs compatibility tests when relevant files change.
# This keeps the main CI fast while ensuring compatibility is verified when needed.

on:
  push:
    branches:
      - main
    paths:
      - 'lib/foxtail/parser/**'
      - 'lib/foxtail/parser.rb'
      - 'lib/foxtail/bundle/ast_converter.rb'
      - 'lib/foxtail/intl/**'
      - 'lib/foxtail/cldr/extractor/**'
      - 'lib/foxtail/cldr/repository/**'
      - 'spec/parser/**'
      - 'compat/**'
      - 'data/cldr/**'
      - '.github/workflows/compatibility.yml'

  pull_request:
    paths:
      - 'lib/foxtail/parser/**'
      - 'lib/foxtail/parser.rb'
      - 'lib/foxtail/bundle/ast_converter.rb'
      - 'lib/foxtail/intl/**'
      - 'lib/foxtail/cldr/extractor/**'
      - 'lib/foxtail/cldr/repository/**'
      - 'spec/parser/**'
      - 'compat/**'
      - 'data/cldr/**'
      - '.github/workflows/compatibility.yml'

  # Allow manual triggering for comprehensive testing
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  fluent-js:
    runs-on: ubuntu-latest
    name: Fluent.js Compatibility
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'  # Use latest supported version
          bundler-cache: true

      - name: Generate Fluent.js compatibility report
        run: |
          bundle exec rake compatibility:fluentjs

      - name: Upload Fluent.js compatibility report
        uses: actions/upload-artifact@v4
        with:
          name: fluentjs-compatibility-report
          path: compat/fluentjs_compatibility_report.md
          retention-days: 30

      - name: Extract Fluent.js compatibility summary
        if: github.event_name == 'pull_request'
        id: extract-summary
        run: |
          # Read the markdown report
          REPORT=$(cat compat/fluentjs_compatibility_report.md)

          # Extract the summary table and total fixtures line
          SUMMARY=$(echo "$REPORT" | sed -n '/## Summary/,/*Total fixtures:/p')

          # Create the comment body
          {
            echo 'body<<EOF'
            echo '## ðŸ“Š Fluent.js Compatibility Report'
            echo ''
            echo "$SUMMARY"
            echo ''
            echo "[Full report available in workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ''
            echo '> ðŸ” This compatibility check ran because parser-related files were modified.'
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Comment PR with Fluent.js compatibility summary
        if: github.event_name == 'pull_request'
        uses: int128/comment-action@v1
        with:
          post: |
            ${{ steps.extract-summary.outputs.body }}

  node-intl:
    runs-on: ubuntu-latest
    name: Node.js Intl Compatibility
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'  # Use latest supported version
          bundler-cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Generate Node.js Intl compatibility report
        run: |
          bundle exec rake compatibility:node_intl

      - name: Upload Node.js Intl compatibility report
        uses: actions/upload-artifact@v4
        with:
          name: node-intl-compatibility-report
          path: compat/node_intl_compatibility_report.md
          retention-days: 30

      - name: Extract Node.js Intl compatibility summary
        if: github.event_name == 'pull_request'
        id: extract-summary
        run: |
          # Read the markdown report
          REPORT=$(cat compat/node_intl_compatibility_report.md)

          # Create the comment body with complete report
          {
            echo 'body<<EOF'
            echo '## ðŸ“Š Node.js Intl Compatibility Report'
            echo ''
            echo "$REPORT"
            echo ''
            echo "[Report also available in workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ''
            echo '> ðŸ” This compatibility check ran because formatter-related files were modified.'
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Comment PR with Node.js Intl compatibility summary
        if: github.event_name == 'pull_request'
        uses: int128/comment-action@v1
        with:
          post: |
            ${{ steps.extract-summary.outputs.body }}